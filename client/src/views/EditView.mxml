<?xml version="1.0" encoding="utf-8"?>
<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="1000" height="1000" creationComplete="onCreationComplete()" clipContent="false" verticalScrollPolicy="off" horizontalScrollPolicy="off">
	<mx:Script>
		<![CDATA[
			import controllers.CreatureController;
			import controllers.DwellingController;
			import controllers.LayerableController;
			import controllers.StoreController;
			import controllers.StructureController;
			import controllers.ThingerController;
			import controllers.UserController;
			
			import flash.utils.getQualifiedClassName;
			import flash.utils.getTimer;
			
			import models.Creature;
			import models.EssentialModelReference;
			import models.OwnedLayerable;
			import models.OwnedStructure;
			import models.OwnedThinger;
			import models.Store;
			import models.StoreOwnedThinger;
			import models.Structure;
			import models.Thinger;
			import models.User;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Text;
			import mx.core.Application;
			import mx.core.FlexGlobals;
			import mx.core.UIComponent;
			import mx.events.DynamicEvent;
			import mx.events.FlexEvent;
			
			import rock_on.Booth;
			import rock_on.BoothBoss;
			import rock_on.ConcertStage;
			import rock_on.ListeningStation;
			import rock_on.ListeningStationBoss;
			import rock_on.StageManager;
			import rock_on.Venue;
			
			import stores.StoreEvent;
			
			import user.UserEvent;
			
			import world.ActiveAsset;
			import world.AssetStack;
			import world.BitmapBlotter;
			import world.Point3D;
			import world.World;	

			public var myWorld:World;
			[Bindable] public var myUser:User;
			
			public var stageView:StageView;
			public var uiLayer:UILayer;
			public var bitmapBlotter:BitmapBlotter;
			public var inventoryCanvas:Canvas;
			public var inventoryIndex:int = 0;
			public var editMode:EditMode;
			public var pausedForStateCompletion:OwnedStructure;
			public var editModeActivated:Boolean = false;
			public var booths:ArrayCollection;
			public var stages:ArrayCollection;
			public var concertStage:ConcertStage;
			[Bindable] public var boothBoss:BoothBoss;
			[Bindable] public var stageManager:StageManager;
			[Bindable] public var listeningStationBoss:ListeningStationBoss;
			
			public var creditsBox:Text;
			
			[Bindable] public var layerableController:LayerableController;
			[Bindable] public var structureController:StructureController;
			[Bindable] public var storeController:StoreController;
			[Bindable] public var creatureController:CreatureController;
			[Bindable] public var thingerController:ThingerController;
			[Bindable] public var userController:UserController;
			[Bindable] public var venueManager:VenueManager;
			[Bindable] public var dwellingController:DwellingController;
			
			[Bindable] public var myMemory:Number;
			[Bindable] public var fps:Number;
			[Bindable] public var aux:Number;	
			public var lastTime:Number;	
			
			public var isDragging:Boolean;
			public var mouseIncrementX:Number;
			public var mouseIncrementY:Number;			
					
			private function onCreationComplete():void
			{
				addEventListener(Event.ENTER_FRAME, onEnterFrame);
				addEventListener(MouseEvent.MOUSE_DOWN, onMouseDown);					
				
				myWorld = new World(WorldView.worldWidth, WorldView.worldHeight, WorldView.tileSize, stageView.concertStage.structure.height);				
				addChild(myWorld);	
												
				editMode = new EditMode(myWorld, this);
				editMode.addEventListener('structurePlaced', onStructurePlaced);
				editMode.structureController = structureController;
				addChild(editMode);		
				initializeSpace();
				
				addUILayer();				
				
				dispatchEditViewCreationEvent();			
			}
			
			private function onMouseDown(evt:MouseEvent):void
			{
				isDragging = true;
				mouseIncrementX = mouseX.valueOf();
				mouseIncrementY = mouseY.valueOf();
				addEventListener(MouseEvent.MOUSE_UP, onMouseUp);
			}
			
			private function dragStage():void
			{		
				stageView.x = stageView.x + (mouseX - mouseIncrementX);
				stageView.y = stageView.y + (mouseY - mouseIncrementY);
				this.x = this.x + (mouseX - mouseIncrementX);
				this.y = this.y + (mouseY - mouseIncrementY);
			}
			
			private function onMouseUp(evt:MouseEvent):void
			{
				isDragging = false;
			}			
			
			private function addUILayer():void
			{
				uiLayer = new UILayer();
				uiLayer.width = width;
				uiLayer.height = height;
				addChild(uiLayer);				
			}			
			
			public function dispatchEditViewCreationEvent():void
			{
				var evt:DynamicEvent = new DynamicEvent("editViewCreated", true, true);
				dispatchEvent(evt);
			}
			
			public function initializeSpace():void
			{
				addStage();
				venueManager = FlexGlobals.topLevelApplication.worldView.venueManager;
				boothBoss.venue = venueManager.venue;
				listeningStationBoss.venue = venueManager.venue;
				boothBoss.editMirror = true;
				boothBoss.setInMotion();
				listeningStationBoss.editMirror = true;
				listeningStationBoss.showListeningStations();
			} 
			
			private function onEnterFrame(evt:Event):void
			{
				var time:Number = getTimer();
				var deltaTime:Number = time - lastTime;
				var lockedDelta:Number = Math.min(100, deltaTime);
				fps = 1000/deltaTime;
				myMemory = System.totalMemory;
				lastTime = time;
				checkDrag();
			}
			
			public function checkDrag():void
			{
				if (isDragging)
				{
					dragStage();
				}				
			}			
			
			public function onUserLoaded():void
			{
			}
			
			public function addStage():void
			{
				stageManager = new StageManager(structureController, myWorld);
				stageManager.editMirror = true;
				stageManager.setInMotion();
				concertStage = stageManager.concertStage;
				stageManager.addStageDecorations(myWorld);
			}			
			
			private function onStructurePlaced(evt:DynamicEvent):void
			{
				thingerController.saveStructurePlacement(evt.asset, evt.currentPoint);
			}
		
			private function onWorldThingerPurchased(evt:UserEvent):void
			{
				creditsBox.text = myUser.credits.toString();
			}
			
			private function addStaticAsset(asset:ActiveAsset, addTo:Point3D):void
			{
//				var addTo:Point3D = new Point3D(Math.floor(Math.random()*myWorld.tilesWide), 0, Math.floor(Math.random()*myWorld.tilesDeep));				
				myWorld.addAsset(asset, addTo);
				asset.movieClip.gotoAndPlay(1);
				asset.movieClip.stop();
			}
			
			public function updateRenderedStructures(os:OwnedStructure, method:String):void
			{
				var asset:ActiveAsset = myWorld.findAssetByThinger(os);
				if (method == "sell")
				{
					myWorld.assetRenderer.removeAsset(asset);
				}
				if (method == "save_placement")
				{
					myWorld.updateAssetCoords(asset, new Point3D(os.x, os.y, os.z), false);
				}
			}							
		]]>
	</mx:Script>	
</mx:Canvas>
